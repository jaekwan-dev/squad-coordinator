# ğŸ—ï¸ NestJS ë°±ì—”ë“œ ê°œë°œ íŒ¨í„´

## ëª¨ë“ˆ êµ¬ì¡°

### í•µì‹¬ ëª¨ë“ˆë“¤
- **AppModule** ([backend/src/app.module.ts](mdc:backend/src/app.module.ts)): ë£¨íŠ¸ ëª¨ë“ˆ
- **AuthModule** ([backend/src/modules/auth/](mdc:backend/src/modules/auth/)): ì¸ì¦ ê´€ë ¨
- **UsersModule** ([backend/src/modules/users/](mdc:backend/src/modules/users/)): ì‚¬ìš©ì ê´€ë¦¬

### ëª¨ë“ˆ íŒ¨í„´
```typescript
@Module({
  imports: [UsersModule, PassportModule, JwtModule.registerAsync({...})],
  controllers: [AuthController],
  providers: [AuthService, KakaoStrategy, JwtStrategy],
  exports: [AuthService],
})
export class AuthModule {}
```

## ì„œë¹„ìŠ¤ íŒ¨í„´

### ì˜ì¡´ì„± ì£¼ì…
```typescript
@Injectable()
export class AuthService {
  constructor(
    private readonly usersService: UsersService,
    private readonly jwtService: JwtService,
  ) {}
}
```

### í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
```typescript
@Injectable()
export class UsersService {
  constructor(private readonly configService: ConfigService) {
    const supabaseUrl = this.configService.get<string>('SUPABASE_URL');
    const supabaseKey = this.configService.get<string>('SUPABASE_SERVICE_KEY');
    
    // í™˜ê²½ë³€ìˆ˜ ê²€ì¦
    if (!supabaseUrl) {
      throw new Error('SUPABASE_URL environment variable is required');
    }
  }
}
```

## ì»¨íŠ¸ë¡¤ëŸ¬ íŒ¨í„´

### REST API ì„¤ê³„
```typescript
@ApiTags('Authentication')
@Controller('auth')
export class AuthController {
  @Get('kakao')
  @UseGuards(AuthGuard('kakao'))
  @ApiOperation({ summary: 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘' })
  async kakaoLogin() {}

  @Get('kakao/callback')
  @UseGuards(AuthGuard('kakao'))
  async kakaoCallback(@Req() req, @Res() res: Response) {}
}
```

### ì‘ë‹µ ì²˜ë¦¬
```typescript
async kakaoCallback(@Req() req, @Res() res: Response) {
  const loginResult = await this.authService.login(req.user);
  const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';
  const token = loginResult.access_token;
  
  res.redirect(`${frontendUrl}/auth/success?token=${token}`);
}
```

## ì¸ì¦ & ë³´ì•ˆ

### Passport ì „ëµ
```typescript
@Injectable()
export class KakaoStrategy extends PassportStrategy(Strategy, 'kakao') {
  constructor(
    private readonly configService: ConfigService,
    private readonly authService: AuthService,
  ) {
    super({
      clientID: configService.get<string>('KAKAO_CLIENT_ID'),
      clientSecret: configService.get<string>('KAKAO_CLIENT_SECRET'),
      callbackURL: configService.get<string>('KAKAO_CALLBACK_URL'),
    });
  }
}
```

### JWT í† í° ìƒì„±
```typescript
async login(user: any) {
  const payload = { 
    sub: user.id, 
    name: user.name,
    is_admin: user.is_admin 
  };
  
  return {
    access_token: this.jwtService.sign(payload),
    user: { /* ì‚¬ìš©ì ì •ë³´ */ },
  };
}
```

## ë°ì´í„°ë² ì´ìŠ¤ (Supabase)

### í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
```typescript
constructor(private readonly configService: ConfigService) {
  const supabaseUrl = this.configService.get<string>('SUPABASE_URL');
  const supabaseKey = this.configService.get<string>('SUPABASE_SERVICE_KEY');
  
  this.supabase = createClient(supabaseUrl, supabaseKey);
}
```

### CRUD ì‘ì—…
```typescript
async create(createUserDto: CreateUserDto) {
  const { data, error } = await this.supabase
    .from('users')
    .insert(createUserDto)
    .select()
    .single();

  if (error) {
    throw new Error(`Failed to create user: ${error.message}`);
  }
  return data;
}
```

## ì—ëŸ¬ ì²˜ë¦¬ & ë¡œê¹…

### êµ¬ì¡°í™”ëœ ë¡œê¹…
```typescript
async validateKakaoUser(kakaoProfile: any): Promise<any> {
  try {
    console.log('ğŸ” [Kakao Auth] Starting validation process...');
    console.log('ğŸ” [Kakao Auth] Profile data:', { kakaoId, username });
    
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    
    console.log('âœ… [Kakao Auth] Validation completed successfully');
    return user;
  } catch (error) {
    console.error('âŒ [Kakao Auth] Validation failed:', error);
    console.error('âŒ [Kakao Auth] Error stack:', error.stack);
    throw error;
  }
}
```

### í™˜ê²½ë³€ìˆ˜ ë””ë²„ê¹…
```typescript
console.log('ğŸ” Environment Variables Check:');
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('SUPABASE_URL:', supabaseUrl ? 'Set âœ…' : 'Missing âŒ');
console.log('SUPABASE_SERVICE_KEY:', supabaseKey ? 'Set âœ…' : 'Missing âŒ');
```

## CORS ì„¤ì •

### í”„ë¡œë•ì…˜ ëŒ€ì‘ CORS
```typescript
// main.tsì—ì„œ CORS ì„¤ì •
app.enableCors({
  origin: [
    'http://localhost:3000',
    'https://localhost:3000',
    process.env.FRONTEND_URL,
    /\.vercel\.app$/,
    /\.render\.com$/,
    /\.onrender\.com$/,
  ].filter(Boolean),
  credentials: true,
});
```
