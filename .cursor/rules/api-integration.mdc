# ğŸ”— API í†µí•© íŒ¨í„´

## ğŸ¯ ì¹´ì¹´ì˜¤ OAuth í”Œë¡œìš°

### Backend (NestJS)
```typescript
// 1. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘
@Get('kakao')
@UseGuards(AuthGuard('kakao'))
async kakaoLogin() {
  // ì¹´ì¹´ì˜¤ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
}

// 2. ì½œë°± ì²˜ë¦¬ ë° JWT ë°œê¸‰
@Get('kakao/callback')  
@UseGuards(AuthGuard('kakao'))
async kakaoCallback(@Req() req, @Res() res) {
  const loginResult = await this.authService.login(req.user);
  res.redirect(`${FRONTEND_URL}/auth/success?token=${loginResult.access_token}`);
}
```

### Frontend (React)
```typescript
// 1. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
const login = () => {
  window.location.href = `${API_BASE_URL}/auth/kakao`;
};

// 2. ì½œë°±ì—ì„œ í† í° ì²˜ë¦¬
useEffect(() => {
  const token = new URLSearchParams(window.location.search).get('token');
  if (token) {
    localStorage.setItem('access_token', token);
    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
  }
}, []);
```

## ğŸ—„ï¸ Supabase ë°ì´í„°ë² ì´ìŠ¤ íŒ¨í„´

### ì‚¬ìš©ì í…Œì´ë¸” êµ¬ì¡°
```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,              -- kakao_123456
  name TEXT NOT NULL,               -- ì‚¬ìš©ì ì´ë¦„
  position_main TEXT NOT NULL,      -- GK, DF, MF, FW
  position_sub TEXT[],              -- ë¶€ í¬ì§€ì…˜ ë°°ì—´
  level INTEGER DEFAULT 3,          -- 1-5 ì‹¤ë ¥ ë ˆë²¨
  is_admin BOOLEAN DEFAULT FALSE,   -- ê´€ë¦¬ì ê¶Œí•œ
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Service ê³„ì¸µ íŒ¨í„´
```typescript
// âœ… ì˜¬ë°”ë¥¸ Supabase ì‚¬ìš©
async create(createUserDto: CreateUserDto) {
  const { data, error } = await this.supabase
    .from('users')
    .insert(createUserDto)
    .select()
    .single();

  if (error) {
    throw new Error(`Failed to create user: ${error.message}`);
  }
  return data;
}
```

## ğŸ” JWT í† í° ê´€ë¦¬

### í† í° ê²€ì¦ í”Œë¡œìš°
```typescript
// Backend: JWT Strategy
async validate(payload: any) {
  const user = await this.usersService.findByKakaoId(payload.sub);
  if (!user) {
    throw new UnauthorizedException('Invalid token');
  }
  return user;
}

// Frontend: í† í° ìë™ ê°±ì‹ 
axios.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // í† í° ë§Œë£Œ ì²˜ë¦¬
      localStorage.removeItem('access_token');
      window.location.href = '/';
    }
    return Promise.reject(error);
  }
);
```

## ğŸ“Š ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´

### Backend ì—ëŸ¬ ì‘ë‹µ
```typescript
// Supabase ì—ëŸ¬ ë³€í™˜
if (error && error.code !== 'PGRST116') { // ë°ì´í„° ì—†ìŒ ì—ëŸ¬ ì œì™¸
  throw new Error(`Database error: ${error.message}`);
}

// HTTP ìƒíƒœ ì½”ë“œ í™œìš©
throw new NotFoundException(`User with ID ${id} not found`);
throw new BadRequestException('Invalid position format');
```

### Frontend ì—ëŸ¬ í•¸ë“¤ë§
```typescript
try {
  const response = await axios.get('/auth/profile');
  setUser(response.data);
} catch (error) {
  console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
  toast.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
}
```
description:
globs:
alwaysApply: false
---
